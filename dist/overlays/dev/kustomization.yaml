apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: dev
resources:
  - ../../base
configMapGenerator:
  - name: pubsub-operator-env-vars
    behavior: create
    envs:
      - .env
  - name: pubsub-operator-default-config
    behavior: create
    files:
      - default.yaml
secretGenerator:
  - name: pubsub-operator-credentials
    behavior: create
    type: Opaque
    files:
      - key.json
patches:
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: pubsub-operator
    patch: |-
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: config
            configMap:
              name: pubsub-operator-default-config
          - name: credentials
            secret:
              name: pubsub-operator-credentials
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: config
            mountPath: /opt/app/config
          - name: credentials
            mountPath: /opt/credentials
      - op: add
        path: /spec/template/spec/containers/1/volumeMounts
        value:
          - name: config
            mountPath: /opt/app/config
          - name: credentials
            mountPath: /opt/credentials
  # - target:
  #     group: rbac.authorization.k8s.io
  #     version: v1
  #     kind: RoleBinding
  #   patch: |-
  #     - op: add
  #       path: /subjects/0/namespace
  #       value: dev
  #     - op: add
  #       path: /subjects
  #       value:
  #         - kind: User
  #           name: 891286530011-compute@developer.gserviceaccount.com
  # - target:
  #     group: apps
  #     version: v1
  #     kind: Deployment
  #   patch: |-
  #     - op: add
  #       path: /spec/template/spec/serviceAccount
  #       value: k8s-service-account@sauce-k8s--yak.iam.gserviceaccount.com